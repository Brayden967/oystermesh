<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Oyster Mesh Debug Tool</title>
    <script src="oy_resources/sha1.js"></script>
    <script src="oystermesh.js"></script>
    <script src="oy_resources/peer.min.js"></script>
    <script src="oy_resources/aes.js"></script>
    <script src="oy_resources/pbkdf2.js"></script>
</head>
<body>
Oyster Mesh<br>
ID: <span id="oy_field_id"></span><br>
Storage limit: <span id="oy_storage_limit"></span><br>
<br><br>
<input id="oy_input_node" type="text" style="width:100px;" />
<input type="button" value="PEER REMOVE" onclick="oy_button()" />
<br><br>
<input id="oy_push_handle" type="text" style="width:100px;" disabled="disabled" />
<input id="oy_push_data" type="text" style="width:100px;" />
<input type="file" id="oy_file_upload" /><br>
<input id="oy_button_push" type="button" value="DATA PUSH" onclick="oy_button2()" />
<input id="oy_button_push_cancel" type="button" disabled="disabled" value="CANCEL" onclick="oy_button3()" />
<input id="oy_button_push_reset" type="button" value="RESET" onclick="oy_button6()" />
<br><br>
<input id="oy_pull_handle" type="text" style="width:100px;" /><br>
<input id="oy_button_pull" type="button" value="DATA PULL" onclick="oy_button4()" />
<input id="oy_button_pull_cancel" type="button" disabled="disabled" value="CANCEL" onclick="oy_button5()" />
<br><br>
<input type="button" value="RESET" onclick="localStorage.clear()" />
<br><br>
PEERS:<br>
<div id="oy_peer_list">
    BLANK
</div><br>
COLLECT:<br>
<div id="oy_collect_list">
    BLANK
</div><br>
CONSTRUCT:<br>
<div id="oy_construct_list">
    BLANK
</div><br>
<script type="text/javascript">
    //oy_peers_clear();
    //console.log(oy_peer_add("bob"));
    //console.log(oy_peers_get());

    //localStorage.clear();

    oy_init(function() {
        document.getElementById("oy_field_id").innerHTML = window.OY_MAIN['oy_self_id'];
        document.getElementById("oy_storage_limit").innerHTML = window.OY_DEPOSIT_MAX;
        oy_maintain();
    });

    function oy_button() {
        oy_peer_remove(document.getElementById('oy_input_node').value);
    }

    function oy_button2() {
        document.getElementById("oy_push_data").disabled = true;
        document.getElementById("oy_button_push").disabled = true;
        document.getElementById("oy_button_push_cancel").disabled = false;
        document.getElementById("oy_push_handle").value = oy_data_push(["OY_LOGIC_SPREAD"], document.getElementById('oy_push_data').value);
    }

    function oy_button3() {
        document.getElementById("oy_push_data").disabled = false;
        document.getElementById("oy_push_handle").disabled = false;
        document.getElementById("oy_button_push").disabled = false;
        document.getElementById("oy_button_push_cancel").disabled = true;
        window.OY_DATA_PUSH[document.getElementById('oy_push_handle').value.substr(32, 48)] = false;
    }

    function oy_button4() {
        document.getElementById("oy_pull_handle").disabled = true;
        document.getElementById("oy_button_pull").disabled = true;
        document.getElementById("oy_button_pull_cancel").disabled = false;
        oy_data_pull(function(oy_superhandle, oy_data_value) {
            oy_button5();
            console.log("HANDLE: "+oy_superhandle);
            console.log("DATA: "+oy_data_value);
            oy_file_download(oy_data_value);
        }, ["OY_LOGIC_SPREAD"], document.getElementById('oy_pull_handle').value);
    }

    function oy_button5() {
        document.getElementById("oy_pull_handle").disabled = false;
        document.getElementById("oy_button_pull").disabled = false;
        document.getElementById("oy_button_pull_cancel").disabled = true;
        window.OY_DATA_PULL[document.getElementById('oy_pull_handle').value.substr(32, 48)] = false;
    }

    function oy_button6() {
        document.getElementById("oy_push_handle").value = "";
        document.getElementById("oy_push_data").value = "";
        document.getElementById("oy_file_upload").value = "";
    }

    function b64toBlob(b64Data, contentType, sliceSize) {
        contentType = contentType || '';
        sliceSize = sliceSize || 512;

        var byteCharacters = atob(b64Data);
        var byteArrays = [];

        for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
            var slice = byteCharacters.slice(offset, offset + sliceSize);

            var byteNumbers = new Array(slice.length);
            for (var i = 0; i < slice.length; i++) {
                byteNumbers[i] = slice.charCodeAt(i);
            }

            var byteArray = new Uint8Array(byteNumbers);

            byteArrays.push(byteArray);
        }

        return new Blob(byteArrays, {type: contentType});
    }

    function oy_file_read(oy_file_object, oy_callback) {
        var file = oy_file_object.target.files[0];
        if (!file) {
            return false;
        }
        console.log(file);
        console.log(file.type);
        var reader = new FileReader();
        reader.onload = function(oy_file_object) {
            oy_callback(JSON.stringify([file.name, file.type, window.btoa(oy_file_object.target.result)]));
        };
        reader.readAsBinaryString(file)
    }

    function oy_file_change(oy_file_object) {
        oy_file_read(oy_file_object, function(oy_file_data) {
            document.getElementById("oy_push_data").value = oy_file_data;
            window.BOB = oy_file_data;
        });
    }
    function oy_file_download(oy_file_raw) {
        let oy_file_data = JSON.parse(oy_file_raw);

        var blobUrl = URL.createObjectURL(b64toBlob(oy_file_data[2], oy_file_data[1]));
        var a = document.createElement("a");
        document.body.appendChild(a);
        a.style = "display: none";
        a.href = blobUrl;
        a.download = oy_file_data[0];
        a.click();
        window.URL.revokeObjectURL(blobUrl);
    }

    document.getElementById("oy_file_upload").addEventListener('change', oy_file_change, false);

    function oy_maintain() {
        let oy_peer_build = "";
        for (let i in window.OY_PEERS) {
            oy_peer_build += i+" LAT: "+window.OY_PEERS[i][2];
            let oy_time_local = Date.now()/1000|0;
            if (window.OY_PEERS[i][4].length>5) {
                while ((oy_time_local-window.OY_PEERS[i][4][0][0])>window.OY_MESH_MEASURE) window.OY_PEERS[i][4].shift();
                let oy_measure_total = 0;
                for (let x in window.OY_PEERS[i][4]) oy_measure_total += window.OY_PEERS[i][4][x][1];
                oy_peer_build += " PUSH: "+(oy_measure_total/(oy_time_local-window.OY_PEERS[i][4][0][0]));
            }
            if (window.OY_PEERS[i][5].length>5) {
                while ((oy_time_local-window.OY_PEERS[i][5][0][0])>window.OY_MESH_MEASURE) window.OY_PEERS[i][5].shift();
                let oy_measure_total = 0;
                for (let x in window.OY_PEERS[i][5]) oy_measure_total += window.OY_PEERS[i][5][x][1];
                oy_peer_build += " PULL: "+(oy_measure_total/(oy_time_local-window.OY_PEERS[i][5][0][0]));
            }
            oy_peer_build +="<br>";
        }
        document.getElementById("oy_peer_list").innerHTML = oy_peer_build;
        let oy_collect_build = "";
        for (let i in window.OY_COLLECT) {
            oy_collect_build += i+"<br>";
            for (let x in window.OY_COLLECT[i]) {
                oy_collect_build += "---"+x+"<br>";
                for (let y in window.OY_COLLECT[i][x]) {
                    oy_collect_build += "------"+y+":"+oy_hash_gen(window.OY_COLLECT[i][x][y])+"<br>";
                }
            }
        }
        document.getElementById("oy_collect_list").innerHTML = oy_collect_build;
        let oy_construct_build = "";
        for (let i in window.OY_CONSTRUCT) {
            oy_construct_build += i+"<br>";
            for (let x in window.OY_CONSTRUCT[i]) {
                oy_construct_build += "---"+x+"<br>";
            }
        }
        document.getElementById("oy_construct_list").innerHTML = oy_construct_build;
        setTimeout("oy_maintain()", 10000);
    }
</script>
</body>
</html>