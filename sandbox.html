<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Oyster Mesh</title>
    <script src="oystermesh.js"></script>
    <script src="oy_resources/peer.min.js"></script>
</head>
<body>
</body>
<input type="file" id="oy_file_upload" /><br>
<input id="oy_button_push_reset" type="button" value="DOWNLOAD" onclick="oy_file_download(window.DATA)" />
<script type="text/javascript">
    window.DATA = null;
    function b64toBlob(b64Data, contentType, sliceSize) {
        contentType = contentType || '';
        sliceSize = sliceSize || 512;

        var byteCharacters = atob(b64Data);
        var byteArrays = [];

        for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
            var slice = byteCharacters.slice(offset, offset + sliceSize);

            var byteNumbers = new Array(slice.length);
            for (var i = 0; i < slice.length; i++) {
                byteNumbers[i] = slice.charCodeAt(i);
            }

            var byteArray = new Uint8Array(byteNumbers);

            byteArrays.push(byteArray);
        }

        var blob = new Blob(byteArrays, {type: contentType});
        return blob;
    }

    function oy_file_read(oy_file_object, oy_callback) {
        var file = oy_file_object.target.files[0];
        if (!file) {
            return false;
        }
        console.log(file);
        console.log(file.type);
        var reader = new FileReader();
        reader.onload = function(oy_file_object) {
            oy_callback(JSON.stringify([file.name, file.type, window.btoa(oy_file_object.target.result)]));
        };
        reader.readAsBinaryString(file)
    }
    function oy_file_upload(oy_file_object) {
        oy_file_read(oy_file_object, function(oy_file_data) {
            window.DATA = oy_file_data;
            console.log(window.DATA);
        });
    }
    function oy_file_download(oy_file_raw) {
        let oy_file_data = JSON.parse(oy_file_raw);

        var blob = b64toBlob(oy_file_data[2], oy_file_data[1]);
        var blobUrl = URL.createObjectURL(blob);
        var a = document.createElement("a");
        document.body.appendChild(a);
        a.style = "display: none";
        a.href = blobUrl;
        a.download = oy_file_data[0];
        a.click();
        window.URL.revokeObjectURL(blobUrl);
    }
    document.getElementById("oy_file_upload").addEventListener('change', oy_file_upload, false);
</script>
</html>
