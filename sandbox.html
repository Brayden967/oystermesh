<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Oyster Mesh</title>
    <script src="oystermesh.js"></script>
    <script src="oy_resources/peer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/pbkdf2.js"></script>
</head>
<body>
Oyster Mesh Sandbox
</body>
<script type="text/javascript">
    function oy_buffer_decode(oy_buffer_buffer, oy_buffer_base64) {
        let binary = '';
        let bytes = new Uint8Array(oy_buffer_buffer);
        let len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
            binary += String.fromCharCode( bytes[ i ] );
        }
        if (oy_buffer_base64===true) return window.btoa(binary);
        return binary;
    }
    function oy_buffer_encode(oy_buffer_text, oy_buffer_base64) {
        let binary_string;
        if (oy_buffer_base64===true) binary_string =  window.atob(oy_buffer_text);
        else binary_string =  oy_buffer_text;
        let len = binary_string.length;
        let bytes = new Uint8Array( len );
        for (let i = 0; i < len; i++)        {
            bytes[i] = binary_string.charCodeAt(i);
        }
        return bytes.buffer;
    }

    function oy_crypt_encrypt(oy_crypt_data, oy_crypt_pass) {
        oy_crypt_data = window.btoa(oy_crypt_data);
        let oy_crypt_salt = CryptoJS.lib.WordArray.random(128/8);
        let oy_crypt_key = CryptoJS.PBKDF2(oy_crypt_pass, oy_crypt_salt, {
            keySize: 8,
            iterations: 100
        });
        let oy_crypt_iv = CryptoJS.lib.WordArray.random(128/8);
        return oy_crypt_salt.toString()+oy_crypt_iv.toString()+CryptoJS.AES.encrypt(oy_crypt_data, oy_crypt_key, {
            iv: oy_crypt_iv,
            padding: CryptoJS.pad.Pkcs7,
            mode: CryptoJS.mode.CBC
        }).toString();
    }

    function oy_crypt_decrypt(oy_crypt_cipher, oy_crypt_pass) {
        let oy_crypt_salt = CryptoJS.enc.Hex.parse(oy_crypt_cipher.substr(0, 32));
        let oy_crypt_iv = CryptoJS.enc.Hex.parse(oy_crypt_cipher.substr(32, 32));
        let oy_crypt_key = CryptoJS.PBKDF2(oy_crypt_pass, oy_crypt_salt, {
            keySize: 8,
            iterations: 100
        });
        return window.atob(CryptoJS.AES.decrypt(oy_crypt_cipher.substring(64), oy_crypt_key, {
            iv: oy_crypt_iv,
            padding: CryptoJS.pad.Pkcs7,
            mode: CryptoJS.mode.CBC

        }).toString(CryptoJS.enc.Utf8));
    }
    let oy_crypt_cipher = oy_crypt_encrypt("Hello World", "Secret Password");
    console.log(oy_crypt_cipher);
    console.log(oy_crypt_decrypt(oy_crypt_cipher, "Secret Password"));
</script>
</html>
